

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Features &mdash; openseries 1.9.7 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=b36c5fd4" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=0f42b3e6"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Single Asset Analysis" href="../examples/single_asset.html" />
    <link rel="prev" title="Risk Management" href="risk_management.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../index.html" class="icon icon-home">
            openseries
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/core_concepts.html">Core Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/data_handling.html">Data Handling</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basic_analysis.html">Basic Financial Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="portfolio_analysis.html">Portfolio Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="risk_management.html">Risk Management</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Advanced Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#custom-analysis-functions">Custom Analysis Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-custom-metrics">Creating Custom Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#advanced-statistical-analysis">Advanced Statistical Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#factor-analysis-and-regression">Factor Analysis and Regression</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#multi-factor-model-analysis">Multi-Factor Model Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rolling-factor-analysis">Rolling Factor Analysis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-portfolio-techniques">Advanced Portfolio Techniques</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#black-litterman-model-implementation">Black-Litterman Model Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#risk-parity-implementation">Risk Parity Implementation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-visualization">Advanced Visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-plotting-functions">Custom Plotting Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance-attribution">Performance Attribution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#integration-with-external-libraries">Integration with External Libraries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#quantlib-integration">QuantLib Integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#machine-learning-integration">Machine Learning Integration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#custom-data-sources">Custom Data Sources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-custom-data-loaders">Creating Custom Data Loaders</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#performance-optimization">Performance Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#efficient-data-processing">Efficient Data Processing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#export-and-reporting">Export and Reporting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#advanced-report-generation">Advanced Report Generation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/single_asset.html">Single Asset Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/multi_asset.html">Multi-Asset Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/portfolio_optimization.html">Portfolio Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/custom_reports.html">Custom Reports</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/openseries.html">openseries package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/series.html">OpenTimeSeries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/frame.html">OpenFrame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/portfoliotools.html">Portfolio Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/simulation.html">Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/report.html">Report Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/datefixer.html">Date Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/types.html">Types and Enums</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/contributing.html">Contributing to openseries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">openseries</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Advanced Features</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/advanced_features.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-features">
<h1>Advanced Features<a class="headerlink" href="#advanced-features" title="Link to this heading"></a></h1>
<p>This tutorial covers advanced openseries features including custom analysis, integration with other libraries, and extending functionality.</p>
<section id="custom-analysis-functions">
<h2>Custom Analysis Functions<a class="headerlink" href="#custom-analysis-functions" title="Link to this heading"></a></h2>
<section id="creating-custom-metrics">
<h3>Creating Custom Metrics<a class="headerlink" href="#creating-custom-metrics" title="Link to this heading"></a></h3>
<p>You can extend openseries with custom analysis functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">yfinance</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">yf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openseries</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenTimeSeries</span><span class="p">,</span> <span class="n">OpenFrame</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Load sample data</span>
<span class="n">ticker</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;^GSPC&quot;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;5y&quot;</span><span class="p">)</span>
<span class="n">sp500</span> <span class="o">=</span> <span class="n">OpenTimeSeries</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">dframe</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;S&amp;P 500&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">custom_risk_metrics</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate custom risk metrics not available in openseries&quot;&quot;&quot;</span>

    <span class="c1"># Convert to returns</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_to_ret</span><span class="p">()</span>
    <span class="n">returns_data</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">tsdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># Custom metrics</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Ulcer Index (alternative to standard deviation)</span>
    <span class="n">drawdowns</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">to_drawdown_series</span><span class="p">()</span>
    <span class="n">dd_data</span> <span class="o">=</span> <span class="n">drawdowns</span><span class="o">.</span><span class="n">tsdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ulcer_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dd_data</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;ulcer_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ulcer_index</span>

    <span class="c1"># Calmar Ratio (annual return / max drawdown)</span>
    <span class="n">calmar_ratio</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">geo_ret</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">max_drawdown</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;calmar_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calmar_ratio</span>

    <span class="c1"># Sterling Ratio (annual return / average drawdown)</span>
    <span class="n">avg_drawdown</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dd_data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">sterling_ratio</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">geo_ret</span> <span class="o">/</span> <span class="n">avg_drawdown</span> <span class="k">if</span> <span class="n">avg_drawdown</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;sterling_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sterling_ratio</span>

    <span class="c1"># Pain Index (average drawdown)</span>
    <span class="n">pain_index</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dd_data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;pain_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pain_index</span>

    <span class="c1"># Tail Ratio (95th percentile / 5th percentile)</span>
    <span class="n">tail_ratio</span> <span class="o">=</span> <span class="n">returns_data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">returns_data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">))</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;tail_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tail_ratio</span>

    <span class="c1"># Gain-to-Pain Ratio</span>
    <span class="n">positive_returns</span> <span class="o">=</span> <span class="n">returns_data</span><span class="p">[</span><span class="n">returns_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">negative_returns</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">returns_data</span><span class="p">[</span><span class="n">returns_data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">gain_to_pain</span> <span class="o">=</span> <span class="n">positive_returns</span> <span class="o">/</span> <span class="n">negative_returns</span> <span class="k">if</span> <span class="n">negative_returns</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;gain_to_pain_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gain_to_pain</span>

    <span class="k">return</span> <span class="n">metrics</span>

<span class="c1"># Calculate custom metrics</span>
<span class="n">custom_metrics</span> <span class="o">=</span> <span class="n">custom_risk_metrics</span><span class="p">(</span><span class="n">sp500</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== CUSTOM RISK METRICS ===&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">custom_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="advanced-statistical-analysis">
<h3>Advanced Statistical Analysis<a class="headerlink" href="#advanced-statistical-analysis" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">advanced_distribution_analysis</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform advanced statistical analysis on returns&quot;&quot;&quot;</span>

    <span class="n">returns</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_to_ret</span><span class="p">()</span>
    <span class="n">returns_data</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">tsdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Jarque-Bera test for normality</span>
    <span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">jarque_bera</span><span class="p">(</span><span class="n">returns_data</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;jarque_bera_stat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jb_stat</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;jarque_bera_pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jb_pvalue</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;is_normal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jb_pvalue</span> <span class="o">&gt;</span> <span class="mf">0.05</span>

    <span class="c1"># Ljung-Box test for autocorrelation</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.stats.diagnostic</span><span class="w"> </span><span class="kn">import</span> <span class="n">acorr_ljungbox</span>
    <span class="n">lb_result</span> <span class="o">=</span> <span class="n">acorr_ljungbox</span><span class="p">(</span><span class="n">returns_data</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ljung_box_pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lb_result</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;has_autocorrelation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ljung_box_pvalue&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span>

    <span class="c1"># ARCH test for heteroscedasticity</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.stats.diagnostic</span><span class="w"> </span><span class="kn">import</span> <span class="n">het_arch</span>
    <span class="n">arch_stat</span><span class="p">,</span> <span class="n">arch_pvalue</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">het_arch</span><span class="p">(</span><span class="n">returns_data</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;arch_test_pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arch_pvalue</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;has_arch_effects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arch_pvalue</span> <span class="o">&lt;</span> <span class="mf">0.05</span>

    <span class="c1"># Hurst exponent (measure of long-term memory)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hurst_exponent</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate Hurst exponent&quot;&quot;&quot;</span>
        <span class="n">lags</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="n">lag</span><span class="p">:],</span> <span class="n">ts</span><span class="p">[:</span><span class="o">-</span><span class="n">lag</span><span class="p">])))</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">]</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lags</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tau</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span>

    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;hurst_exponent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hurst_exponent</span><span class="p">(</span><span class="n">returns_data</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Perform advanced analysis</span>
<span class="n">advanced_stats</span> <span class="o">=</span> <span class="n">advanced_distribution_analysis</span><span class="p">(</span><span class="n">sp500</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== ADVANCED STATISTICAL ANALYSIS ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Jarque-Bera p-value: </span><span class="si">{</span><span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;jarque_bera_pvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Returns are normal: </span><span class="si">{</span><span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;is_normal&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ljung-Box p-value: </span><span class="si">{</span><span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;ljung_box_pvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Has autocorrelation: </span><span class="si">{</span><span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;has_autocorrelation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ARCH test p-value: </span><span class="si">{</span><span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;arch_test_pvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Has ARCH effects: </span><span class="si">{</span><span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;has_arch_effects&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hurst exponent: </span><span class="si">{</span><span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;hurst_exponent&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Interpret Hurst exponent</span>
<span class="k">if</span> <span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;hurst_exponent&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  → Persistent/trending behavior&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">advanced_stats</span><span class="p">[</span><span class="s1">&#39;hurst_exponent&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  → Mean-reverting behavior&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  → Random walk behavior&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="factor-analysis-and-regression">
<h2>Factor Analysis and Regression<a class="headerlink" href="#factor-analysis-and-regression" title="Link to this heading"></a></h2>
<section id="multi-factor-model-analysis">
<h3>Multi-Factor Model Analysis<a class="headerlink" href="#multi-factor-model-analysis" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load factor data (Fama-French factors would be ideal, using proxies here)</span>
<span class="n">factor_tickers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;^GSPC&quot;</span><span class="p">:</span> <span class="s2">&quot;Market&quot;</span><span class="p">,</span>
    <span class="s2">&quot;^RUT&quot;</span><span class="p">:</span> <span class="s2">&quot;Small Cap&quot;</span><span class="p">,</span>  <span class="c1"># Size factor proxy</span>
    <span class="s2">&quot;EFA&quot;</span><span class="p">:</span> <span class="s2">&quot;International&quot;</span><span class="p">,</span>  <span class="c1"># International factor</span>
    <span class="s2">&quot;TLT&quot;</span><span class="p">:</span> <span class="s2">&quot;Bonds&quot;</span>  <span class="c1"># Interest rate factor</span>
<span class="p">}</span>

<span class="c1"># Load factor data</span>
<span class="n">factor_series</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">factor_tickers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;3y&quot;</span><span class="p">)</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">OpenTimeSeries</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">dframe</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">factor_series</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Create factor frame</span>
<span class="n">factors</span> <span class="o">=</span> <span class="n">OpenFrame</span><span class="p">(</span><span class="n">constituents</span><span class="o">=</span><span class="n">factor_series</span><span class="p">)</span>

<span class="c1"># Load individual stock for analysis</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">Ticker</span><span class="p">(</span><span class="s2">&quot;AAPL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="s2">&quot;3y&quot;</span><span class="p">)</span>
<span class="n">apple</span> <span class="o">=</span> <span class="n">OpenTimeSeries</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">dframe</span><span class="o">=</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Apple&quot;</span><span class="p">)</span>

<span class="c1"># Add stock to factor frame for regression</span>
<span class="n">analysis_frame</span> <span class="o">=</span> <span class="n">OpenFrame</span><span class="p">(</span><span class="n">constituents</span><span class="o">=</span><span class="n">factor_series</span> <span class="o">+</span> <span class="p">[</span><span class="n">apple</span><span class="p">])</span>

<span class="c1"># Perform multi-factor regression</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">regression_results</span> <span class="o">=</span> <span class="n">analysis_frame</span><span class="o">.</span><span class="n">multi_factor_linear_regression</span><span class="p">(</span>
        <span class="n">dependent_variable_idx</span><span class="o">=-</span><span class="mi">1</span>  <span class="c1"># Apple is the last series (dependent variable)</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== MULTI-FACTOR REGRESSION RESULTS ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regression Summary:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">regression_results</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Factor Loadings (Betas):&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">factor_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">factor_series</span><span class="p">]):</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">regression_results</span><span class="p">[</span><span class="s1">&#39;coefficients&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Skip intercept</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">factor_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">beta</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">R-squared: </span><span class="si">{</span><span class="n">regression_results</span><span class="p">[</span><span class="s1">&#39;r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjusted R-squared: </span><span class="si">{</span><span class="n">regression_results</span><span class="p">[</span><span class="s1">&#39;adj_r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regression analysis failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="rolling-factor-analysis">
<h3>Rolling Factor Analysis<a class="headerlink" href="#rolling-factor-analysis" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rolling beta analysis with market</span>
<span class="n">market_series</span> <span class="o">=</span> <span class="n">factor_series</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># S&amp;P 500</span>
<span class="n">stock_vs_market</span> <span class="o">=</span> <span class="n">OpenFrame</span><span class="p">(</span><span class="n">constituents</span><span class="o">=</span><span class="p">[</span><span class="n">apple</span><span class="p">,</span> <span class="n">market_series</span><span class="p">])</span>

<span class="c1"># Calculate rolling beta</span>
<span class="n">rolling_beta</span> <span class="o">=</span> <span class="n">stock_vs_market</span><span class="o">.</span><span class="n">rolling_beta</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>  <span class="c1"># 1-year rolling</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== ROLLING BETA ANALYSIS ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Beta: </span><span class="si">{</span><span class="n">rolling_beta</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Beta: </span><span class="si">{</span><span class="n">rolling_beta</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Beta Range: </span><span class="si">{</span><span class="n">rolling_beta</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rolling_beta</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Beta Volatility: </span><span class="si">{</span><span class="n">rolling_beta</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Rolling correlation</span>
<span class="n">rolling_corr</span> <span class="o">=</span> <span class="n">stock_vs_market</span><span class="o">.</span><span class="n">rolling_corr</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">252</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== ROLLING CORRELATION ANALYSIS ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current Correlation: </span><span class="si">{</span><span class="n">rolling_corr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average Correlation: </span><span class="si">{</span><span class="n">rolling_corr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation Range: </span><span class="si">{</span><span class="n">rolling_corr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rolling_corr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-portfolio-techniques">
<h2>Advanced Portfolio Techniques<a class="headerlink" href="#advanced-portfolio-techniques" title="Link to this heading"></a></h2>
<section id="black-litterman-model-implementation">
<h3>Black-Litterman Model Implementation<a class="headerlink" href="#black-litterman-model-implementation" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">black_litterman_weights</span><span class="p">(</span><span class="n">returns_df</span><span class="p">,</span> <span class="n">market_caps</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">0.025</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplified Black-Litterman model implementation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate market-implied returns</span>
    <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span> <span class="o">*</span> <span class="mi">252</span>  <span class="c1"># Annualized</span>
    <span class="n">market_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">market_caps</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">market_caps</span><span class="p">)</span>

    <span class="c1"># Market-implied equilibrium returns</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">market_weights</span><span class="p">)</span>

    <span class="c1"># Without views, BL reduces to market weights</span>
    <span class="c1"># In practice, you would incorporate investor views here</span>

    <span class="c1"># Calculate BL weights (simplified - no views)</span>
    <span class="n">bl_weights</span> <span class="o">=</span> <span class="n">market_weights</span>  <span class="c1"># Without views, equals market weights</span>

    <span class="k">return</span> <span class="n">bl_weights</span><span class="p">,</span> <span class="n">pi</span>

<span class="c1"># Example with our portfolio assets</span>
<span class="k">if</span> <span class="s1">&#39;portfolio_assets&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="c1"># Get returns data</span>
    <span class="n">returns_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">portfolio_assets</span><span class="o">.</span><span class="n">constituents</span><span class="p">:</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_to_ret</span><span class="p">()</span>
        <span class="n">returns_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">tsdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">returns_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">returns_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">returns_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">portfolio_assets</span><span class="o">.</span><span class="n">constituents</span><span class="p">]</span>

    <span class="c1"># Simulate market caps (in practice, use real market cap data)</span>
    <span class="n">market_caps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>  <span class="c1"># Billions</span>

    <span class="n">bl_weights</span><span class="p">,</span> <span class="n">implied_returns</span> <span class="o">=</span> <span class="n">black_litterman_weights</span><span class="p">(</span><span class="n">returns_df</span><span class="p">,</span> <span class="n">market_caps</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== BLACK-LITTERMAN MODEL ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market-implied returns:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">returns_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">implied_returns</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ret</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Black-Litterman weights:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">returns_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">bl_weights</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="risk-parity-implementation">
<h3>Risk Parity Implementation<a class="headerlink" href="#risk-parity-implementation" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">risk_parity_weights</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate risk parity weights using iterative algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>  <span class="c1"># Start with equal weights</span>

    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
        <span class="c1"># Calculate risk contributions</span>
        <span class="n">portfolio_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)))</span>
        <span class="n">marginal_contrib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">portfolio_vol</span>
        <span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">marginal_contrib</span>

        <span class="c1"># Target risk contribution (equal for all assets)</span>
        <span class="n">target_risk</span> <span class="o">=</span> <span class="n">portfolio_vol</span> <span class="o">/</span> <span class="n">n</span>

        <span class="c1"># Update weights</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_risk</span> <span class="o">/</span> <span class="n">risk_contrib</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># Normalize</span>

        <span class="c1"># Check convergence</span>
        <span class="n">risk_contrib_new</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="n">portfolio_vol</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">risk_contrib_new</span> <span class="o">-</span> <span class="n">target_risk</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">weights</span>

<span class="c1"># Calculate risk parity weights</span>
<span class="k">if</span> <span class="s1">&#39;returns_df&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns_df</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">252</span>  <span class="c1"># Annualized</span>
    <span class="n">rp_weights</span> <span class="o">=</span> <span class="n">risk_parity_weights</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== RISK PARITY WEIGHTS ===&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">returns_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rp_weights</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">weight</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create risk parity portfolio</span>
    <span class="k">if</span> <span class="s1">&#39;portfolio_assets&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">rp_portfolio</span> <span class="o">=</span> <span class="n">portfolio_assets</span><span class="o">.</span><span class="n">make_portfolio</span><span class="p">(</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">rp_weights</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Risk Parity Portfolio&quot;</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Risk Parity Portfolio Metrics:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Return: </span><span class="si">{</span><span class="n">rp_portfolio</span><span class="o">.</span><span class="n">geo_ret</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volatility: </span><span class="si">{</span><span class="n">rp_portfolio</span><span class="o">.</span><span class="n">vol</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Sharpe: </span><span class="si">{</span><span class="n">rp_portfolio</span><span class="o">.</span><span class="n">ret_vol_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="advanced-visualization">
<h2>Advanced Visualization<a class="headerlink" href="#advanced-visualization" title="Link to this heading"></a></h2>
<section id="custom-plotting-functions">
<h3>Custom Plotting Functions<a class="headerlink" href="#custom-plotting-functions" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_risk_return_scatter</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create risk-return scatter plot&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>

    <span class="c1"># Get metrics for all assets</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">all_properties</span><span class="p">()</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;geo_ret&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">volatilities</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;vol&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">sharpe_ratios</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;ret_vol_ratio&#39;</span><span class="p">]</span>

    <span class="c1"># Create scatter plot</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">volatilities</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">returns</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+text&#39;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">returns</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;top center&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="n">sharpe_ratios</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span>  <span class="c1"># Size based on Sharpe ratio</span>
            <span class="n">color</span><span class="o">=</span><span class="n">sharpe_ratios</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Viridis&#39;</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Sharpe Ratio&quot;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Assets&#39;</span>
    <span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Risk-Return Analysis&#39;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Volatility (%)&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Annual Return (%)&#39;</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Create risk-return plot</span>
<span class="k">if</span> <span class="s1">&#39;portfolio_assets&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="n">risk_return_fig</span> <span class="o">=</span> <span class="n">create_risk_return_scatter</span><span class="p">(</span><span class="n">portfolio_assets</span><span class="p">)</span>
    <span class="c1"># risk_return_fig.show()  # Uncomment to display</span>
</pre></div>
</div>
</section>
<section id="performance-attribution">
<h3>Performance Attribution<a class="headerlink" href="#performance-attribution" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">performance_attribution_chart</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create performance attribution waterfall chart&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>

    <span class="c1"># Calculate individual contributions using OpenFrame</span>
    <span class="n">asset_metrics</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">all_properties</span><span class="p">()</span>
    <span class="n">asset_returns</span> <span class="o">=</span> <span class="n">asset_metrics</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;geo_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">contributions</span> <span class="o">=</span> <span class="p">[</span><span class="n">weight</span> <span class="o">*</span> <span class="n">ret</span> <span class="k">for</span> <span class="n">weight</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">asset_returns</span><span class="p">)]</span>

    <span class="c1"># Create waterfall chart</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Waterfall</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Performance Attribution&quot;</span><span class="p">,</span>
        <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span>
        <span class="n">measure</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;relative&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">contributions</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">],</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">series</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">constituents</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Portfolio&quot;</span><span class="p">],</span>
        <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;outside&quot;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contrib</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="n">contributions</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">contributions</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="n">contributions</span> <span class="o">+</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">contributions</span><span class="p">)],</span>
        <span class="n">connector</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(63, 63, 63)&quot;</span><span class="p">}},</span>
    <span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Portfolio Performance Attribution&quot;</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Contribution to Return (%)&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># Create attribution chart</span>
<span class="k">if</span> <span class="s1">&#39;portfolio_assets&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;equal_weights&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="n">attribution_fig</span> <span class="o">=</span> <span class="n">performance_attribution_chart</span><span class="p">(</span><span class="n">portfolio_assets</span><span class="p">,</span> <span class="n">equal_weights</span><span class="p">)</span>
    <span class="c1"># attribution_fig.show()  # Uncomment to display</span>
</pre></div>
</div>
</section>
</section>
<section id="integration-with-external-libraries">
<h2>Integration with External Libraries<a class="headerlink" href="#integration-with-external-libraries" title="Link to this heading"></a></h2>
<section id="quantlib-integration">
<h3>QuantLib Integration<a class="headerlink" href="#quantlib-integration" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example of integrating with QuantLib for advanced calculations</span>
<span class="c1"># Note: Requires &#39;pip install QuantLib-Python&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">QuantLib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ql</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_option_greeks</span><span class="p">(</span><span class="n">spot_price</span><span class="p">,</span> <span class="n">strike</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">time_to_expiry</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate option Greeks using QuantLib&quot;&quot;&quot;</span>

        <span class="c1"># Set up the option</span>
        <span class="n">payoff</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">PlainVanillaPayoff</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">Option</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">strike</span><span class="p">)</span>
        <span class="n">exercise</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">EuropeanExercise</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">todaysDate</span><span class="p">()</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_to_expiry</span> <span class="o">*</span> <span class="mi">365</span><span class="p">))</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">VanillaOption</span><span class="p">(</span><span class="n">payoff</span><span class="p">,</span> <span class="n">exercise</span><span class="p">)</span>

        <span class="c1"># Set up the Black-Scholes process</span>
        <span class="n">spot_handle</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">QuoteHandle</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">SimpleQuote</span><span class="p">(</span><span class="n">spot_price</span><span class="p">))</span>
        <span class="n">flat_ts</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">YieldTermStructureHandle</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">FlatForward</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">todaysDate</span><span class="p">(),</span> <span class="n">risk_free_rate</span><span class="p">,</span> <span class="n">ql</span><span class="o">.</span><span class="n">Actual365Fixed</span><span class="p">()))</span>
        <span class="n">flat_vol_ts</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">BlackVolTermStructureHandle</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">BlackConstantVol</span><span class="p">(</span><span class="n">ql</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">todaysDate</span><span class="p">(),</span> <span class="n">ql</span><span class="o">.</span><span class="n">NullCalendar</span><span class="p">(),</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">ql</span><span class="o">.</span><span class="n">Actual365Fixed</span><span class="p">()))</span>

        <span class="n">bs_process</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">BlackScholesProcess</span><span class="p">(</span><span class="n">spot_handle</span><span class="p">,</span> <span class="n">flat_ts</span><span class="p">,</span> <span class="n">flat_vol_ts</span><span class="p">)</span>

        <span class="c1"># Set up the pricing engine</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">ql</span><span class="o">.</span><span class="n">AnalyticEuropeanEngine</span><span class="p">(</span><span class="n">bs_process</span><span class="p">)</span>
        <span class="n">option</span><span class="o">.</span><span class="n">setPricingEngine</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

        <span class="c1"># Calculate Greeks</span>
        <span class="n">greeks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">NPV</span><span class="p">(),</span>
            <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">delta</span><span class="p">(),</span>
            <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">gamma</span><span class="p">(),</span>
            <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">theta</span><span class="p">(),</span>
            <span class="s1">&#39;vega&#39;</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">vega</span><span class="p">(),</span>
            <span class="s1">&#39;rho&#39;</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">rho</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">greeks</span>

    <span class="c1"># Example usage with current market data</span>
    <span class="n">current_price</span> <span class="o">=</span> <span class="n">sp500</span><span class="o">.</span><span class="n">tsdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">implied_vol</span> <span class="o">=</span> <span class="n">sp500</span><span class="o">.</span><span class="n">vol</span>  <span class="c1"># Use historical vol as proxy for implied vol</span>

    <span class="n">greeks</span> <span class="o">=</span> <span class="n">calculate_option_greeks</span><span class="p">(</span>
        <span class="n">spot_price</span><span class="o">=</span><span class="n">current_price</span><span class="p">,</span>
        <span class="n">strike</span><span class="o">=</span><span class="n">current_price</span><span class="p">,</span>  <span class="c1"># At-the-money</span>
        <span class="n">risk_free_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>   <span class="c1"># 5% risk-free rate</span>
        <span class="n">volatility</span><span class="o">=</span><span class="n">implied_vol</span><span class="p">,</span>
        <span class="n">time_to_expiry</span><span class="o">=</span><span class="mf">0.25</span>    <span class="c1"># 3 months</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== OPTION GREEKS (ATM, 3M expiry) ===&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">greek</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">greeks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">greek</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;QuantLib not available. Install with: pip install QuantLib-Python&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="machine-learning-integration">
<h3>Machine Learning Integration<a class="headerlink" href="#machine-learning-integration" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example of using machine learning for return prediction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>

<span class="k">def</span><span class="w"> </span><span class="nf">ml_return_prediction</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">lookback_window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use machine learning to predict future returns&quot;&quot;&quot;</span>

    <span class="c1"># Convert to returns</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_to_ret</span><span class="p">()</span>
    <span class="n">returns_data</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">tsdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># Create features (lagged returns and technical indicators)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lookback_window</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">returns_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">forecast_horizon</span><span class="p">):</span>
        <span class="c1"># Features: past returns and simple moving averages</span>
        <span class="n">past_returns</span> <span class="o">=</span> <span class="n">returns_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">lookback_window</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">sma_5</span> <span class="o">=</span> <span class="n">returns_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">sma_20</span> <span class="o">=</span> <span class="n">returns_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">20</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">volatility</span> <span class="o">=</span> <span class="n">returns_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">20</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="n">feature_vector</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">past_returns</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">sma_5</span><span class="p">,</span> <span class="n">sma_20</span><span class="p">,</span> <span class="n">volatility</span><span class="p">]</span>
        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_vector</span><span class="p">)</span>

        <span class="c1"># Target: future return</span>
        <span class="n">future_return</span> <span class="o">=</span> <span class="n">returns_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">forecast_horizon</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future_return</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

    <span class="c1"># Split data</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">features</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
    <span class="p">)</span>

    <span class="c1"># Train model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Make predictions</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Evaluate</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s1">&#39;mse&#39;</span><span class="p">:</span> <span class="n">mse</span><span class="p">,</span>
        <span class="s1">&#39;r2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span>
        <span class="s1">&#39;feature_importance&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">results</span>

<span class="c1"># Apply ML prediction</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ml_results</span> <span class="o">=</span> <span class="n">ml_return_prediction</span><span class="p">(</span><span class="n">sp500</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== MACHINE LEARNING PREDICTION RESULTS ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Squared Error: </span><span class="si">{</span><span class="n">ml_results</span><span class="p">[</span><span class="s1">&#39;mse&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R-squared Score: </span><span class="si">{</span><span class="n">ml_results</span><span class="p">[</span><span class="s1">&#39;r2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top 3 Important Features:&quot;</span><span class="p">)</span>

    <span class="n">importance_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ml_results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">])[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">importance_indices</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. Feature </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ml_results</span><span class="p">[</span><span class="s1">&#39;feature_importance&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ML analysis failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="custom-data-sources">
<h2>Custom Data Sources<a class="headerlink" href="#custom-data-sources" title="Link to this heading"></a></h2>
<section id="creating-custom-data-loaders">
<h3>Creating Custom Data Loaders<a class="headerlink" href="#creating-custom-data-loaders" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomDataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom data loader for various data sources&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_csv_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">date_column</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">value_column</span><span class="o">=</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Custom Series&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data from CSV file&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">date_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_column</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">date_column</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">OpenTimeSeries</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">dframe</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">value_column</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_database</span><span class="p">(</span><span class="n">connection_string</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">date_column</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">value_column</span><span class="o">=</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;DB Series&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data from database&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connection_string</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">date_column</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="n">date_column</span><span class="p">])</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">OpenTimeSeries</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">dframe</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">value_column</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_api</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date_field</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">value_field</span><span class="o">=</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;API Series&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data from REST API&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">date_field</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">value_field</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">OpenTimeSeries</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">dates</span><span class="o">=</span><span class="n">dates</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<span class="c1"># Example usage (commented out as it requires actual data sources)</span>
<span class="c1"># custom_series = CustomDataLoader.from_csv_file(&#39;data.csv&#39;, name=&#39;Custom Data&#39;)</span>
</pre></div>
</div>
</section>
</section>
<section id="performance-optimization">
<h2>Performance Optimization<a class="headerlink" href="#performance-optimization" title="Link to this heading"></a></h2>
<section id="efficient-data-processing">
<h3>Efficient Data Processing<a class="headerlink" href="#efficient-data-processing" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">optimize_large_dataset_processing</span><span class="p">(</span><span class="n">series_list</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimize processing of large datasets&quot;&quot;&quot;</span>

    <span class="c1"># Process in chunks to manage memory</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">series_list</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">series_list</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">]</span>

        <span class="c1"># Process chunk</span>
        <span class="n">chunk_frame</span> <span class="o">=</span> <span class="n">OpenFrame</span><span class="p">(</span><span class="n">constituents</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">chunk_metrics</span> <span class="o">=</span> <span class="n">chunk_frame</span><span class="o">.</span><span class="n">all_properties</span><span class="p">()</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk_metrics</span><span class="p">)</span>

        <span class="c1"># Clear memory</span>
        <span class="k">del</span> <span class="n">chunk_frame</span><span class="p">,</span> <span class="n">chunk_metrics</span>

    <span class="c1"># Combine results</span>
    <span class="n">final_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_results</span>

<span class="c1"># Parallel processing example</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parallel_metric_calculation</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate metrics for a single series (for parallel processing)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">geo_ret</span><span class="p">,</span>
        <span class="s1">&#39;volatility&#39;</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">vol</span><span class="p">,</span>
        <span class="s1">&#39;sharpe&#39;</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">ret_vol_ratio</span><span class="p">,</span>
        <span class="s1">&#39;max_drawdown&#39;</span><span class="p">:</span> <span class="n">series</span><span class="o">.</span><span class="n">max_drawdown</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_series_parallel</span><span class="p">(</span><span class="n">series_list</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process multiple series in parallel&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parallel_metric_calculation</span><span class="p">,</span> <span class="n">series_list</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

<span class="c1"># Example usage</span>
<span class="k">if</span> <span class="s1">&#39;portfolio_assets&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== PERFORMANCE OPTIMIZATION EXAMPLE ===&quot;</span><span class="p">)</span>

    <span class="c1"># Sequential processing</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">sequential_results</span> <span class="o">=</span> <span class="n">portfolio_assets</span><span class="o">.</span><span class="n">all_properties</span><span class="p">()</span>
    <span class="n">sequential_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sequential processing time: </span><span class="si">{</span><span class="n">sequential_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="c1"># Note: Parallel processing would be beneficial for larger datasets</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parallel processing is most beneficial with 100+ assets&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="export-and-reporting">
<h2>Export and Reporting<a class="headerlink" href="#export-and-reporting" title="Link to this heading"></a></h2>
<section id="advanced-report-generation">
<h3>Advanced Report Generation<a class="headerlink" href="#advanced-report-generation" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">generate_comprehensive_report</span><span class="p">(</span><span class="n">portfolio</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;comprehensive_report.html&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a comprehensive HTML report&quot;&quot;&quot;</span>

    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;!DOCTYPE html&gt;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;Portfolio Analysis Report&lt;/title&gt;</span>
<span class="s2">        &lt;style&gt;</span>
<span class="s2">            body </span><span class="se">{{</span><span class="s2"> font-family: Arial, sans-serif; margin: 40px; </span><span class="se">}}</span>
<span class="s2">            .header </span><span class="se">{{</span><span class="s2"> background-color: #f0f0f0; padding: 20px; border-radius: 5px; </span><span class="se">}}</span>
<span class="s2">            .metric </span><span class="se">{{</span><span class="s2"> margin: 10px 0; </span><span class="se">}}</span>
<span class="s2">            .section </span><span class="se">{{</span><span class="s2"> margin: 30px 0; </span><span class="se">}}</span>
<span class="s2">            table </span><span class="se">{{</span><span class="s2"> border-collapse: collapse; width: 100%; </span><span class="se">}}</span>
<span class="s2">            th, td </span><span class="se">{{</span><span class="s2"> border: 1px solid #ddd; padding: 8px; text-align: left; </span><span class="se">}}</span>
<span class="s2">            th </span><span class="se">{{</span><span class="s2"> background-color: #f2f2f2; </span><span class="se">}}</span>
<span class="s2">        &lt;/style&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">        &lt;div class=&quot;header&quot;&gt;</span>
<span class="s2">            &lt;h1&gt;Portfolio Analysis Report&lt;/h1&gt;</span>
<span class="s2">            &lt;p&gt;Generated on: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Portfolio: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Period: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">first_idx</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">last_idx</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">        &lt;/div&gt;</span>

<span class="s2">        &lt;div class=&quot;section&quot;&gt;</span>
<span class="s2">            &lt;h2&gt;Performance Summary&lt;/h2&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;Total Return: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">value_ret</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;Annualized Return: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">geo_ret</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;Annualized Volatility: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">vol</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;Sharpe Ratio: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">ret_vol_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;Maximum Drawdown: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">max_drawdown</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>

<span class="s2">        &lt;div class=&quot;section&quot;&gt;</span>
<span class="s2">            &lt;h2&gt;Risk Metrics&lt;/h2&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;95% VaR (daily): </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">var_down</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;95% CVaR (daily): </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">cvar_down</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;Sortino Ratio: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">sortino_ratio</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;Skewness: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">skew</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;div class=&quot;metric&quot;&gt;Kurtosis: </span><span class="si">{</span><span class="n">portfolio</span><span class="o">.</span><span class="n">kurtosis</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comprehensive report saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Generate report</span>
<span class="k">if</span> <span class="s1">&#39;portfolio&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
    <span class="n">generate_comprehensive_report</span><span class="p">(</span><span class="n">portfolio</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== ADVANCED FEATURES TUTORIAL COMPLETE ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You&#39;ve learned about:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;• Custom metrics and analysis functions&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;• Advanced statistical analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;• Factor models and regression&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;• Advanced portfolio techniques&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;• Custom visualization&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;• External library integration&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;• Performance optimization&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;• Advanced reporting&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This tutorial demonstrates how to extend openseries with advanced functionality for sophisticated financial analysis workflows.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="risk_management.html" class="btn btn-neutral float-left" title="Risk Management" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../examples/single_asset.html" class="btn btn-neutral float-right" title="Single Asset Analysis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Captor Fund Management AB.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>